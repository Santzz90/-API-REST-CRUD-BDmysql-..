<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento de Veículos</title>
    
    <link rel="stylesheet" href="css/style.css"> 
</head>
<body>

    <h1>Gerenciamento de Veículos</h1>

    <section>
        <h2>Cadastro e Atualização de Veículos</h2>
        
        <form id="veiculoForm">
            <input type="hidden" id="inputId" value=""> 

            <fieldset>
                <legend id="formLegend">Cadastrar Novo Veículo</legend>
                
                <label for="marca">Marca:</label>
                <input type="text" id="marca" name="marca" required>
                
                <label for="modelo">Modelo:</label>
                <input type="text" id="modelo" name="modelo" required>
                
                <label for="ano">Ano:</label>
                <input type="number" id="ano" name="ano" required>
                
                <label for="cor">Cor:</label>
                <input type="text" id="cor" name="cor" required>
            </fieldset>

            <div style="margin-top: 20px;">
                <button type="submit" id="submitButton">Salvar Veículo</button> 
                <button type="button" onclick="resetFormulario()">Limpar</button>
            </div>
            <p id="formStatus" class="status-message"></p>
        </form>
    </section>

    <section>
        <h2>Veículos Cadastrados</h2>
        
        <button type="button" onclick="carregarVeiculos()">Atualizar Lista de Veículos</button>
        <p id="tabelaStatus" class="status-message" data-success="true">Clique em "Atualizar Lista de Veículos" para carregar os dados.</p>

        <table id="motoristasTable"> 
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Marca</th>
                    <th>Modelo</th>
                    <th>Ano</th>
                    <th>Cor</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody id="veiculosTableBody">
                </tbody> 
        </table>
    </section>
    
<script>
    const API_BASE_URL = 'http://localhost:8081'; 

    // Referências aos elementos do DOM
    const form = document.getElementById('veiculoForm');
    const inputId = document.getElementById('inputId');
    const formLegend = document.getElementById('formLegend');
    const submitButton = document.getElementById('submitButton');
    const formStatus = document.getElementById('formStatus');
    const tabelaStatus = document.getElementById('tabelaStatus');
    const veiculosTableBody = document.getElementById('veiculosTableBody');

    // 

    function displayStatus(element, message, isSuccess) {
        element.textContent = message;
        element.setAttribute('data-success', isSuccess ? 'true' : 'false');
    }

    function resetFormulario() {
        form.reset();
        inputId.value = '';
        formLegend.textContent = 'Cadastrar Novo Veículo';
        submitButton.textContent = 'Salvar Veículo';
        submitButton.classList.remove('update-mode');
        displayStatus(formStatus, 'Formulário limpo e pronto para novo cadastro.', true);
        document.getElementById('marca').focus();
    }
    
    // CRUD: GET (Carregar e Popular Tabela)

    function popularTabelaVeiculos(veiculos) {
        veiculosTableBody.innerHTML = ''; 

        if (!veiculos || veiculos.length === 0) {
            displayStatus(tabelaStatus, 'Nenhum veículo encontrado.', false);
            return;
        }

        veiculos.forEach(veiculo => {
            const row = veiculosTableBody.insertRow();
            
            // Dados
            row.insertCell().textContent = veiculo.id;
            row.insertCell().textContent = veiculo.marca;
            row.insertCell().textContent = veiculo.modelo;
            row.insertCell().textContent = veiculo.ano;
            row.insertCell().textContent = veiculo.cor;

            // Coluna Ações
            const actionsCell = row.insertCell();
            
            // Botão Editar
            const editBtn = document.createElement('button');
            editBtn.textContent = 'Editar';
            editBtn.setAttribute('onclick', `preencherFormularioParaEdicaoVeiculo(${veiculo.id}, '${veiculo.marca}', '${veiculo.modelo}', ${veiculo.ano}, '${veiculo.cor}')`);
            
            // Botão Excluir
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Excluir';
            deleteBtn.setAttribute('onclick', `excluirVeiculo(${veiculo.id})`);

            actionsCell.appendChild(editBtn);
            actionsCell.appendChild(deleteBtn);
        });
        
        displayStatus(tabelaStatus, `Lista atualizada com ${veiculos.length} veículos.`, true);
    }

    async function carregarVeiculos() {
        displayStatus(tabelaStatus, 'Carregando lista de veículos...', false);
        veiculosTableBody.innerHTML = ''; 

        try {
            const response = await fetch(`${API_BASE_URL}/`);
            const data = await response.json();

            if (response.ok) {
                popularTabelaVeiculos(data);
            } else {
                displayStatus(tabelaStatus, `Erro ao carregar veículos: ${data.message || response.statusText}`, false);
            }
        } catch (error) {
            displayStatus(tabelaStatus, `Erro de conexão: ${error.message}. Verifique se a API está rodando.`, false);
        }
    }


    //  CRUD: PREENCHER FORM (Edição) 

    function preencherFormularioParaEdicaoVeiculo(id, marca, modelo, ano, cor) {
        resetFormulario(); 
        
        // Configura para modo de atualização
        inputId.value = id;
        formLegend.textContent = `Atualizar Veículo ID: ${id}`;
        submitButton.textContent = 'Atualizar Veículo';
        submitButton.classList.add('update-mode');

        // Preenche os campos com os valores atuais
        document.getElementById('marca').value = marca;
        document.getElementById('modelo').value = modelo;
        document.getElementById('ano').value = ano;
        document.getElementById('cor').value = cor;
        
        displayStatus(formStatus, `Dados do Veículo ID ${id} carregados para edição.`, true);
        
        // Rola até o formulário
        form.scrollIntoView({ behavior: 'smooth' });
    }

    // CRUD: DELETE (Excluir) 

    async function excluirVeiculo(id) {
        if (!confirm(`Tem certeza que deseja EXCLUIR o veículo com ID ${id}? Esta ação é irreversível!`)) {
            return;
        }

        displayStatus(tabelaStatus, `Excluindo veículo ID ${id}...`, false);

        try {
            const response = await fetch(`${API_BASE_URL}/deletar/${id}`, { method: 'DELETE' });
            
            
            let responseText = await response.text();
            
            if (response.ok || responseText.includes("deletado com sucesso")) {
                displayStatus(tabelaStatus, `Veículo ID ${id} excluído com sucesso!`, true);
                carregarVeiculos(); 
            } else {
                displayStatus(tabelaStatus, `Erro ao excluir veículo ID ${id}: ${responseText || response.statusText}`, false);
            }
        } catch (error) {
            displayStatus(tabelaStatus, `Erro de conexão ao tentar excluir: ${error.message}`, false);
        }
    }
    
    //  CRUD: POST/PATCH (Salvar/Atualizar)

    form.addEventListener('submit', async function(event) {
        event.preventDefault();
        
        const isUpdate = inputId.value !== '';
        const id = inputId.value;
        const method = isUpdate ? 'PATCH' : 'POST';
        const endpoint = isUpdate ? `${API_BASE_URL}/atualizar/${id}` : `${API_BASE_URL}/cadastro`;

        const data = {
            marca: document.getElementById('marca').value,
            modelo: document.getElementById('modelo').value,
            ano: parseInt(document.getElementById('ano').value),
            cor: document.getElementById('cor').value
        };

        displayStatus(formStatus, isUpdate ? `Enviando atualização para ID ${id}...` : 'Enviando cadastro...', false);

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            
            let responseText = await response.text();

            if (response.ok) {
                const message = isUpdate ? 
                    `Veículo ID ${id} atualizado com sucesso!` : 
                    `Cadastro realizado com sucesso! ${responseText}`;
                
                displayStatus(formStatus, message, true);
                resetFormulario(); 
                carregarVeiculos(); // Atualiza a tabela
            } else {
                displayStatus(formStatus, `Erro ao ${isUpdate ? 'atualizar' : 'cadastrar'}: ${responseText || response.statusText}`, false);
            }

        } catch (error) {
            displayStatus(formStatus, `Erro de conexão: ${error.message}`, false);
        }
    });

    // Inicializa a tabela ao carregar a página
    window.onload = carregarVeiculos; 

</script>
       

</body>
</html>